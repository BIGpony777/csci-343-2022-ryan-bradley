<html>
  <head>
    <link rel = "stylesheet" href = "https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity = "sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin = "anonymous">        
     
      <style>
            /* put your css styles here...*/

      </style>
  </head>
  
  <body>
    <div id="menu">
      <div class="jumbotron jumbotron-fluid">
        <div class="container" id="jumble">
          <h4 class="display-4">Treasure hunt game</h4>
          <p class="lead">This is the coolest game you have ever played, please enjoy it thoroughly</p>
          <p>Note: click on the game title at any point to return to the main menu</p>
      </div>
    </div> 
            
    <nav class="navbar navbar-light bg-light">
      <a class="navbar-brand" href="#">
        <img src="https://static.tappedout.net/mtg-cards-2/unfinity/blood-crypt/femme_fatale-blood-crypt-unf-16418741540.png" width="40" height="30" alt="">
                      Treasure Hunt Games
      </a>
      <button id='btn-play' type="button" class="btn btn-secondary" style="display: none">Play</button>
      <button id='btn-history' type="button" class="btn btn-secondary" style="display: none">History</button>
      <button id='btn-settings' type="button" class="btn btn-secondary" style="display: none">Settings</button>
      <button id='btn-login' type="button" class="btn btn-secondary">Login</button>
      <button id='btn-logout' type="button" class="btn btn-secondary" style="display: none">Logout</button>
      <button id='btn-register' type="button" class="btn btn-secondary">Register</button>
      <button id='btn-stats' type="button" class="btn btn-secondary" style="display: none">Stats</button>
    </nav>
    <div id = "response2"></div>
    </div>

    <div id = "game" style="display: none">
      <h4 id="home">Treasure Hunt</h4>
      <div id = "main"></div>
      <div class = "clearfix"></div>
      <br>
      <div id = "response"></div>
    </div>
        
    <script src = "https://code.jquery.com/jquery-3.3.1.min.js" integrity = "sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin = "anonymous"></script>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity = "sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin = "anonymous"></script>
    <script src = "https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity = "sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin = "anonymous"></script>        
        
        <!--put your modal dialogs here...-->
    <div id = "my-Modal" class = "modal" data-backdrop="static" tabindex = "-1" role = "dialog">
      <div class = "modal-dialog" role = "document">
        <div class = "modal-content">
          <div class = "modal-header bg-dark text-light">
            <h5 class="modal-title" id="winscreen">Play Again?</h5>
          </div>
          <div class = "modal-body">
            <p>Would you like to play again?</p>
          </div>
          <div class = "modal-footer bg-dark">
            <button type = "button" class = "btn btn-primary" data-dismiss = "modal" id = "yes">Yes</button>
            <button type = "button" class = "btn btn-secondary" data-dismiss = "modal" id = "no">No</button>
          </div>
        </div>
      </div>
    </div> 

    <div id = "settings-Modal" class = "modal" tabindex = "-1" role = "dialog">
      <div class = "modal-dialog" role = "document">
        <div class = "modal-content">
          <div class = "modal-header bg-dark text-light">
            <h5 class = "modal-title">Settings</h5>
          </div>
          <div class = "modal-body">
            <form class="border border-primary p-3">
              <div class="form-group">
                <label for="num1">Size of game</label>
                <input type="number" class="form-control" id="GameSize" name="GameSize" placeholder="How big do you want your game?">
              </div>
              <div class="form-group">
                <label for="num2">Guesses Allowed</label>
                <input type="number" class="form-control" id="GuessNum" name="GuessNum" placeholder="How many guesses do you want?">
              </div>
          </div>
          <br>
          <button id='settings-submit' type="button" class="btn btn-primary float-right p-3">Enter</button>
        </div>
      </div>
    </div>
         

    <div id = "login-Modal" class = "modal" tabindex = "-1" role = "dialog">
      <div class = "modal-dialog" role = "document">
        <div class = "modal-content">
          <div class = "modal-header bg-dark text-light">
            <h5 class = "modal-title">Login</h5>
          </div>
          <div class = "modal-body">
            <form class="border border-primary p-3">
              <div class="form-group">
                <label for="num1">Email</label>
                <input type="text" class="form-control" id="Email" name="Email" placeholder="Enter Email">
              </div>
              <div class="form-group">
                <label for="num2">Password</label>
                <input type="password" class="form-control" id="Password" name="Password" placeholder="Enter Password">
              </div>
          </div>
          <br>
          <button id='login-Submit' type="button" class="btn btn-primary float-right p-3">Enter</button>
        </div>
      </div>
    </div> 

    <div id = "register-Modal" class = "modal" tabindex = "-1" role = "dialog">
      <div class = "modal-dialog" role = "document">
        <div class = "modal-content">
          <div class = "modal-header bg-dark text-light">
            <h5 class = "modal-title">Register</h5>
          </div>
          <div class = "modal-body">
            <form class="border border-primary p-3">
              <div class="form-group">
                <label for="num1">Email</label>
                <input type="text" class="form-control" id="REmail" name="REmail" placeholder="Enter Email">
              </div>
              <div class="form-group">
                <label for="num2">Password</label>
                <input type="password" class="form-control" id="RPassword" name="RPassword" placeholder="Enter Password">
              </div>
          </div>
          <br>
          <button id='Register-Submit' type="button" class="btn btn-primary float-right p-3">Enter</button>
        </div>
      </div>
    </div>
        
    <script>
    //TODO make a menu that lets you reset games and change parameters, show best game at bottom, add in stats, confimration window for return button, restart entirely using updateView correctly and writing a function for jqxhr calls with included callback function

    /* global $ */
    // put your JavaScript code here...
      $(document).ready(function(){
          
        // model and user keys
        let model = {};
        let user = {};

        function initializeModel(){
          model.error = "";
          model.gameStatus = "";
          model.guesses = 0;
          model.card;
          model.ready;
          model.set;
          model.size=6;
          model.value=1;
          model.condition =4;
        }

        function initializeUser(){
          user.email;
          user.logged==false;
        }

        function refresh(){

          var jqxhr = $.get('isLogged');
          jqxhr.done(function(json) 
          {  
            if (json.error !== undefined)
            {
              user.logged = false;
              model.error = json.error;
              let txt = model.error;         
              $("#response2").text(txt);
              console.log(user.logged);
            }
            else
            {
              user.logged = true;
              switchButtons();
            }
          });
          jqxhr.fail(function(json) 
          {
            let error = JSON.stringify(json);
            model.error = error;
            console.log(model.error);
          });
        }

        function isLogged(){

          var jqxhr = $.get('isLogged');
          jqxhr.done(function(json) 
          {   
            if (json.error !== undefined){
              user.logged = false;
              model.error = json.error;
              let txt = model.error;         
              $("#response2").text(txt);
              console.log(user.logged);
            }else{
              user.logged = true;
              console.log(user.logged);
            }
          });
          jqxhr.fail(function(json) 
          {
            let error = JSON.stringify(json);
            model.error = error;
            console.log(model.error);
          });
            
        };
          
        function switchButtons(){
          $('#btn-play').toggle(2000);
          $('#btn-login').toggle(2000);
          $('#btn-register').toggle(2000);
          $('#btn-logout').toggle(2000);
          $('#btn-history').toggle(2000);
          $('#btn-settings').toggle(2000);
          $('#btn-stats').toggle(2000);
        }
          
        // view..
        function updateView(){
          isLogged();
          if(user.logged==false){return};
          if(model.set==undefined){
            const rows = document.querySelectorAll('.row');
            rows.forEach(box => {
            box.remove();
            });
            //add style for rows, cols, card, and card body
            for(let i = 0; i < Math.floor(model.size / 2); i++){
            $('#main').append('<div class = "row no-gutters" style = "height:200px"><div class = "col-sm no-gutters"><div class = "card " style = "height:200px"><div class = "card-body bg-dark" value = ' + model.value + '></div></div></div><div class = "col-sm"><div class = "card" style = "height:200px"><div class = "card-body bg-dark" value = ' + parseInt(model.value + 1, 10) + '></div></div></div></div>');
            model.value += 2;
          }
          if(model.size % 2 == 1){
            $('#main').append('<div class = "row" style = "height:200px"><div class = "col-sm"><div class = "card"style = "height:200px"><div class = "card-body bg-dark"value = ' + model.value + '></div></div></div>');
          }
          let txt = "Guesses: " + 0;              
          $("#response").text(txt);
          model.set = 1;
          }
          if (model.error != ""){
            $("#response").text(model.error);
          }
          else
          {
            console.log(model.gameStatus);
            if(model.gameStatus == 'won'){
              txt = "Guesses: " + model.guesses;              
              $("#response").text(txt);
              model.card.removeClass('bg-dark');
              model.card.addClass('bg-success');
              $('#my-Modal').modal('show');
              $('#winscreen').text('CONGRATULATIONS HOMIE!!! YOU HAVE WON');
            }else if(model.gameStatus == 'lost'){
              txt = "Guesses: " + model.guesses;              
              $("#response").text(txt);
              model.card.removeClass('bg-dark');
              model.card.addClass('bg-danger');
              $('#my-Modal').modal('show');
              $('#winscreen').text('bruh. you lose. get GOOD please??');
            }else if(model.gameStatus==''){
              model.card.removeClass('bg-dark');
              model.card.addClass('bg-danger');
              txt = "Guesses: " + model.guesses;              
              $("#response").text(txt);
              }
          } 
        }

        //TODO add modal to verify they want to leave
        $('#home').click(function(){
          
            $('#game').toggle(2000);
            $('#menu').toggle(2000);
        });
          
        //history and stats buttons
        $('#btn-history').click(function(){

            isLogged();
            if(user.logged==false){
                let txt = "you gotta log back in bro";             
                $("#response2").text(txt);
                return
            };
            var jqxhr = $.get("listScores");
            jqxhr.done(function(json) 
            {
              if (json.error !== undefined){
                model.error = json.error;
                let txt = model.error;         
              $("#response").text(txt);
              }else{
                let txt = JSON.stringify(json.result);             
                $("#response2").text(txt);
              }
            })
            jqxhr.fail(function(json) 
            {
              let error = JSON.stringify(json);
              model.error = error;
            })
        });

        $('#btn-stats').click(function(){
          isLogged();
          if(user.logged==false){
            let txt = "you gotta log back in bro";             
            $("#response2").text(txt);
            return
          };
          var jqxhr = $.get("listStats");
          jqxhr.done(function(json) 
          {
            if (json.error !== undefined){
              model.error = json.error;
              let txt = model.error;         
            $("#response").text(txt);
            }else{
              let txt = JSON.stringify(json.result);             
              $("#response2").text(txt);
            }
          })
          jqxhr.fail(function(json) 
          {
            let error = JSON.stringify(json);
            model.error = error;
          })
          });

        //settings TODO make a settings table to save user settings
        $('#btn-settings').click(function(){
          $('#settings-Modal').modal('show');
        });

        $('#settings-submit').click(function(){
          model.size = $('#GameSize').val();
          model.condition = $('#GuessNum').val();
          $('#settings-Modal').modal('hide');
          model.set=undefined;
          updateView();
        });
          
        //play button
        $('#btn-play').click(function(){
          isLogged();
          if(user.logged==false){
            let txt = "you need to login to play";              
            $("#response2").text(txt);
            switchButtons();
          }else{
            $('#menu').toggle(2000);
            $('#game').toggle(2000);
            let txt = "Guesses: " + 0;              
            $("#response").text(txt);
            updateView();
            $('.card-body').removeClass('bg-danger');
            $('.card-body').addClass('bg-dark');
          }
        });

        //logout button
        $('#btn-logout').click(function(){
          sendRequest(logout);
        });

        //login button
        $('#btn-login').click(function(){
          $('#login-Modal').modal('show');
        });

        $('#login-Submit').click(function(){
          let url;

          let email = $('#Email').val().trim();
          let password = $('#Password').val().trim();
          url = 'login?email=' + email+ '&password=' + password;

          var jqxhr = $.get(url);
          jqxhr.done(function(json) 
          {
              user.email = "";
            if (json.error !== undefined)
            {
              model.error = json.error;
              let txt = model.error;              
              $("#response2").text(txt);
            }
            else
            {
              user.logged=true;
              model.error = "";
              user.email = json.result.email;
              console.log(user.email);
              let txt = "logged in as " + user.email;              
            $("#response2").text(txt);

            switchButtons();
            }
          })
          jqxhr.fail(function(json) 
          {
              let error = JSON.stringify(json);
              model.error = error;
          })
          $('#login-Modal').modal('hide');
        });

        //register button
        $('#btn-register').click(function(){
          $('#register-Modal').modal('show');
        });

        $('#Register-Submit').click(function(){
          let url;
          let email = $('#REmail').val().trim();
          let password = $('#RPassword').val().trim();
          url = 'register?email=' + email+ '&password=' + password;
          console.log(url);
          user.email="";
          var jqxhr = $.get(url);
          jqxhr.done(function(json) 
          {
            if (json.error !== undefined)
            {
              model.error = json.error;
              let txt = model.error;              
              $("#response2").text(txt);
            }
            else
            {
              user.email = json.result.email;
              let txt = "logged in as " + user.email;              
              $("#response2").text(txt);
              switchButtons();
              model.error = "";
              user.logged = true;
            }
          })
          jqxhr.fail(function(json) 
          {
            let error = JSON.stringify(json);
            model.error = error;
          })
          $('#register-Modal').modal('hide');
        });

        //win screen...
        $('#yes').click(function(){
          isLogged();
          if(user.logged==false){return};
          let url;
          $('.card-body').removeClass('bg-success');
          $('.card-body').removeClass('bg-danger');
          $('.card-body').addClass('bg-dark');
          url = 'addScore?score='+parseInt(model.guesses);
          var jqxhr = $.get(url);
          jqxhr.done(function(json) 
          {
              model.gameStatus = "";
              if (json.error !== undefined)
              {
                model.error = json.error;
              }
              else
              {
                model.ready = undefined;
                model.guesses = 0;
                  txt = "Guesses: " + model.guesses;              
                $("#response").text(txt);   
              }
          })
          jqxhr.fail(function(json) 
          {
            let error = JSON.stringify(json);
            model.error = error;
          })}
        );

        $('#no').click(function(){

          isLogged();
          if(user.logged==false){return};
          
          $('.card-body').removeClass('bg-success');
          $('.card-body').removeClass('bg-danger');
          $('.card-body').addClass('bg-dark');
          
          let url = 'addScore?score='+parseInt(model.guesses);
          console.log(url);
              
          var jqxhr = $.get(url);
          jqxhr.done(function(json) 
          {
              model.gameStatus = "";
              if (json.error !== undefined)
              {
                model.error = json.error;
              }
              else
              {
                model.ready = undefined;
                model.guesses = 0;
                  txt = "Guesses: " + model.guesses;              
                $("#response").text(txt);   
                $('#game').toggle(2000);
                $('#menu').toggle(2000);
              }
          })
          jqxhr.fail(function(json) 
          {
            let error = JSON.stringify(json);
            model.error = error;
          })
        });
        
        // controller...
        $(document).on('click','.card-body', model ,function() {
          model.card = $(this);
          let url;
          if(model.card.hasClass('bg-danger') != true){
            if(model.ready == undefined){
              url = 'game?max=' + model.size.toString(10) + '&guess=' + $(this).attr('value')+'&condition='+model.condition.toString(10);
              model.ready = 1;
            }else if(model.ready == 1){
              url = 'game?guess=' + $(this).attr('value');
          }
          var jqxhr = $.get(url);
          jqxhr.done(function(json) 
          {
              model.gameStatus = "";
              if (json.error !== undefined)
              {
                model.error = json.error;
              }
              else
              {
                model.gameStatus = json.gameStatus;
                model.guesses = json.guesses;
              }
              updateView();
          })
          jqxhr.fail(function(json) 
          {
            let error = JSON.stringify(json);
            model.error = error;
            updateView();
          })} 
        });
        // run...
        initializeModel();
        initializeUser();
        refresh(); 
    });        
      </script>
  </body>
</html>